<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PicoClaw Dashboard</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0b0d13;--bg2:#111520;--card:#161b2e;--card2:#1c2238;
  --border:#252d45;--border2:#2f3a5a;
  --text:#e2e8f0;--text2:#94a3b8;--text3:#5a6478;
  --accent:#6366f1;--accent2:#818cf8;
  --ok:#22c55e;--err:#ef4444;--warn:#f59e0b;--info:#3b82f6;
  --radius:10px;--radius-sm:6px;
  --font-mono:'Cascadia Code','Fira Code','Consolas','Courier New',monospace;
}
html,body{height:100%;font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);font-size:14px}
a{color:var(--accent2);text-decoration:none}
input,button,textarea,select{font-family:inherit}

/* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
header{display:flex;align-items:center;gap:16px;padding:14px 28px;background:var(--bg2);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
.logo{font-size:20px;font-weight:700;letter-spacing:-.5px;display:flex;align-items:center;gap:10px}
.logo span{color:var(--accent2)}
.status-pill{display:inline-flex;align-items:center;gap:7px;padding:5px 14px;border-radius:20px;font-size:12px;font-weight:600;background:rgba(34,197,94,.12);color:var(--ok)}
.status-pill.stopped{background:rgba(239,68,68,.12);color:var(--err)}
.status-dot{width:8px;height:8px;border-radius:50%;background:currentColor}
.status-pill:not(.stopped) .status-dot{animation:pulse 2s infinite}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(34,197,94,.5)}50%{box-shadow:0 0 0 6px rgba(34,197,94,0)}}
.hdr-right{margin-left:auto;display:flex;align-items:center;gap:12px;font-size:12px;color:var(--text3)}

/* â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
nav{display:flex;gap:2px;padding:0 28px;background:var(--bg2);border-bottom:1px solid var(--border)}
.tab{padding:12px 22px;font-size:13px;font-weight:500;color:var(--text2);cursor:pointer;border-bottom:2px solid transparent;transition:.15s;user-select:none}
.tab:hover{color:var(--text)}
.tab.active{color:var(--accent2);border-bottom-color:var(--accent)}

/* â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
main{padding:24px 28px;max-width:1200px}
section{display:none}section.active{display:block}
h2{font-size:17px;font-weight:600;margin-bottom:16px}

/* â”€â”€ Cards (status tab) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px;margin-bottom:20px}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px}
.card h3{font-size:12px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.6px;margin-bottom:12px}
.card-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;font-size:13px}
.card-row .label{color:var(--text2)}.card-row .value{font-weight:500;font-family:var(--font-mono);font-size:12px;max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.card-row .value.ok{color:var(--ok)}.card-row .value.err{color:var(--err)}.card-row .value.warn{color:var(--warn)}

/* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
button,.btn{padding:8px 18px;border-radius:var(--radius-sm);border:1px solid var(--border);font-size:12px;font-weight:600;cursor:pointer;background:var(--card2);color:var(--text);transition:.15s;display:inline-flex;align-items:center;gap:6px}
button:hover{background:var(--border);border-color:var(--border2)}
button:active{transform:scale(.97)}
button:disabled{opacity:.4;cursor:not-allowed;transform:none}
.btn-ok{background:rgba(34,197,94,.15);color:var(--ok);border-color:rgba(34,197,94,.3)}.btn-ok:hover{background:rgba(34,197,94,.25)}
.btn-err{background:rgba(239,68,68,.15);color:var(--err);border-color:rgba(239,68,68,.3)}.btn-err:hover{background:rgba(239,68,68,.25)}
.btn-accent{background:rgba(99,102,241,.2);color:var(--accent2);border-color:rgba(99,102,241,.3)}.btn-accent:hover{background:rgba(99,102,241,.3)}
.btn-warn{background:rgba(245,158,11,.15);color:var(--warn);border-color:rgba(245,158,11,.3)}.btn-warn:hover{background:rgba(245,158,11,.25)}
.spinner{width:14px;height:14px;border:2px solid transparent;border-top-color:currentColor;border-radius:50%;animation:spin .6s linear infinite;display:none}
@keyframes spin{to{transform:rotate(360deg)}}
button.loading .spinner{display:inline-block}button.loading{pointer-events:none;opacity:.6}

/* â”€â”€ Config: Sections / Accordion â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cfg-toolbar{display:flex;gap:10px;margin-bottom:18px;flex-wrap:wrap;align-items:center}
.mode-toggle{display:flex;border:1px solid var(--border);border-radius:var(--radius-sm);overflow:hidden}
.mode-toggle button{border:none;border-radius:0;padding:7px 16px;font-size:12px;background:transparent;color:var(--text2)}
.mode-toggle button.active{background:var(--accent);color:#fff}
.cfg-toolbar .spacer{flex:1}

.cfg-section{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:10px;overflow:hidden}
.cfg-section.sub{background:var(--card2);border-color:var(--border);margin:0 0 6px 0;border-radius:var(--radius-sm)}
.sec-hdr{display:flex;align-items:center;gap:10px;padding:14px 18px;cursor:pointer;user-select:none;transition:.1s}
.sec-hdr:hover{background:rgba(255,255,255,.02)}
.cfg-section.sub .sec-hdr{padding:10px 14px}
.sec-arrow{font-size:10px;color:var(--text3);transition:transform .2s;display:inline-block;width:14px}
.cfg-section.open>.sec-hdr .sec-arrow{transform:rotate(90deg)}
.sec-icon{font-size:16px}
.cfg-section.sub .sec-icon{font-size:14px}
.sec-title{font-size:13px;font-weight:600;color:var(--text)}
.cfg-section.sub .sec-title{font-size:12px;font-weight:500}
.sec-status{width:7px;height:7px;border-radius:50%;margin-left:auto;flex-shrink:0}
.sec-status.on{background:var(--ok);box-shadow:0 0 6px rgba(34,197,94,.4)}
.sec-status.off{background:var(--err);opacity:.5}

.sec-body{display:none;padding:2px 18px 16px}
.cfg-section.sub .sec-body{padding:2px 14px 12px}
.cfg-section.open>.sec-body{display:block;animation:fadeIn .15s}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}

/* â”€â”€ Config: Form Fields â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.f-row{display:flex;align-items:center;padding:9px 0;border-bottom:1px solid rgba(255,255,255,.03);gap:12px}
.f-row:last-child{border-bottom:none}
.f-row>label{font-size:12px;color:var(--text2);min-width:150px;flex-shrink:0}
.f-row input[type="text"],.f-row input[type="password"],.f-row input[type="number"]{
  flex:1;max-width:400px;padding:7px 12px;background:var(--bg);border:1px solid var(--border);
  border-radius:var(--radius-sm);color:var(--text);font-size:12px;font-family:var(--font-mono);outline:none}
.f-row input:focus{border-color:var(--accent)}
.f-row input[type="number"]{max-width:140px}

/* Toggle switch */
.toggle{position:relative;width:40px;height:22px;flex-shrink:0}
.toggle input{opacity:0;width:0;height:0;position:absolute}
.toggle .sl{position:absolute;inset:0;background:var(--border);border-radius:11px;cursor:pointer;transition:.2s}
.toggle .sl::before{content:'';position:absolute;width:16px;height:16px;border-radius:50%;left:3px;bottom:3px;background:#fff;transition:.2s}
.toggle input:checked+.sl{background:var(--accent)}
.toggle input:checked+.sl::before{transform:translateX(18px)}

/* Range slider */
.range-wrap{display:flex;align-items:center;gap:10px;flex:1;max-width:300px}
.range-wrap input[type="range"]{flex:1;accent-color:var(--accent);height:4px;background:var(--border);border-radius:2px;outline:none;-webkit-appearance:none;appearance:none}
.range-wrap input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--accent);cursor:pointer}
.range-val{font-family:var(--font-mono);font-size:12px;color:var(--accent2);min-width:30px;text-align:center}

/* Secret field */
.secret-wrap{position:relative;flex:1;max-width:400px;display:flex}
.secret-wrap input{flex:1;padding-right:36px}
.eye-btn{position:absolute;right:6px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:13px;padding:2px;color:var(--text3);opacity:.7}
.eye-btn:hover{opacity:1}

/* Tags field */
.tags-wrap{display:flex;flex-wrap:wrap;gap:5px;flex:1;max-width:460px;padding:5px 8px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);min-height:34px;align-items:center}
.tags-wrap:focus-within{border-color:var(--accent)}
.tag{display:flex;align-items:center;gap:4px;padding:2px 8px;background:rgba(99,102,241,.18);border-radius:4px;font-size:11px;font-family:var(--font-mono);color:var(--accent2)}
.tag-x{cursor:pointer;opacity:.5;font-size:13px;line-height:1}.tag-x:hover{opacity:1;color:var(--err)}
.tag-in{border:none;background:none;color:var(--text);font-size:12px;font-family:var(--font-mono);flex:1;min-width:70px;outline:none;padding:2px 0}

/* â”€â”€ Config: Raw JSON editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#raw-editor{display:none}
#config-editor{width:100%;min-height:500px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:16px;color:var(--text);font-family:var(--font-mono);font-size:12px;line-height:1.6;resize:vertical;tab-size:2;outline:none}
#config-editor:focus{border-color:var(--accent)}
.validation-box{margin-top:12px;padding:12px 16px;border-radius:var(--radius-sm);font-size:12px;display:none}
.validation-box.ok{display:block;background:rgba(34,197,94,.1);color:var(--ok);border:1px solid rgba(34,197,94,.2)}
.validation-box.warn{display:block;background:rgba(245,158,11,.1);color:var(--warn);border:1px solid rgba(245,158,11,.2)}
.validation-box.err{display:block;background:rgba(239,68,68,.1);color:var(--err);border:1px solid rgba(239,68,68,.2)}
.validation-box ul{margin:6px 0 0 18px}

/* â”€â”€ Logs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.log-toolbar{display:flex;gap:10px;margin-bottom:12px;align-items:center}
.log-toolbar .spacer{flex:1}
#log-viewer{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:14px;height:520px;overflow-y:auto;font-family:var(--font-mono);font-size:11px;line-height:1.7;color:var(--text2)}
.log-line{white-space:pre-wrap;word-break:break-all}
.log-line .ts{color:var(--text3)}.log-line .gw{color:var(--info)}

/* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#toast-box{position:fixed;top:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{padding:11px 18px;border-radius:var(--radius-sm);font-size:12px;font-weight:500;animation:slideIn .2s;min-width:240px;box-shadow:0 8px 24px rgba(0,0,0,.4)}
.toast.ok{background:#166534;color:#bbf7d0;border:1px solid #22c55e40}
.toast.err{background:#7f1d1d;color:#fecaca;border:1px solid #ef444440}
.toast.warn{background:#78350f;color:#fde68a;border:1px solid #f59e0b40}
.toast.info{background:#1e3a5f;color:#bfdbfe;border:1px solid #3b82f640}
@keyframes slideIn{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}

/* â”€â”€ No-config state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty-state{text-align:center;padding:60px 20px;color:var(--text2)}
.empty-state h3{font-size:18px;color:var(--text);margin-bottom:10px}
.empty-state p{margin-bottom:20px;font-size:13px}
</style>
</head>
<body>

<header>
  <div class="logo">&#x1F99E; <span>PicoClaw</span></div>
  <div id="status-pill" class="status-pill stopped"><div class="status-dot"></div><span id="status-text">Stopped</span></div>
  <div class="hdr-right"><span id="hdr-pid"></span><span id="hdr-uptime"></span></div>
</header>
<nav>
  <div class="tab active" data-tab="dashboard">Status</div>
  <div class="tab" data-tab="config">Configuration</div>
  <div class="tab" data-tab="logs">Logs</div>
</nav>

<main>
<!-- â•â•â• STATUS TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section id="tab-dashboard" class="active">
  <div class="cards">
    <div class="card">
      <h3>Gateway Control</h3>
      <div class="card-row"><span class="label">Status</span><span class="value" id="gw-status">â€”</span></div>
      <div class="card-row"><span class="label">PID</span><span class="value" id="gw-pid">â€”</span></div>
      <div class="card-row"><span class="label">Uptime</span><span class="value" id="gw-uptime">â€”</span></div>
      <div class="card-row"><span class="label">Health</span><span class="value" id="gw-health">â€”</span></div>
      <div class="btn-row">
        <button class="btn-ok" id="btn-start" onclick="gwAction('/api/start','btn-start')"><div class="spinner"></div>Start</button>
        <button class="btn-err" id="btn-stop" onclick="gwAction('/api/stop','btn-stop')"><div class="spinner"></div>Stop</button>
        <button class="btn-warn" id="btn-restart" onclick="gwAction('/api/restart','btn-restart')"><div class="spinner"></div>Restart</button>
      </div>
    </div>
    <div class="card">
      <h3>System</h3>
      <div class="card-row"><span class="label">Binary</span><span class="value" id="s-bin">â€”</span></div>
      <div class="card-row"><span class="label">Binary exists</span><span class="value" id="s-bin-ok">â€”</span></div>
      <div class="card-row"><span class="label">Config</span><span class="value" id="s-cfg">â€”</span></div>
      <div class="card-row"><span class="label">Config exists</span><span class="value" id="s-cfg-ok">â€”</span></div>
      <div class="card-row"><span class="label">Health port</span><span class="value" id="s-port">â€”</span></div>
    </div>
  </div>
</section>

<!-- â•â•â• CONFIG TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section id="tab-config">
  <div class="cfg-toolbar">
    <div class="mode-toggle">
      <button class="active" id="mode-visual" onclick="switchMode('visual')">Visual</button>
      <button id="mode-raw" onclick="switchMode('raw')">Raw JSON</button>
    </div>
    <button class="btn-ok" onclick="saveConfig()"><div class="spinner"></div>Save</button>
    <button class="btn-warn" onclick="validateCfg()"><div class="spinner"></div>Validate</button>
    <button onclick="createDefault()"><div class="spinner"></div>Create Default</button>
    <div class="spacer"></div>
    <button class="btn-accent" onclick="loadConfig()">Reload</button>
  </div>
  <div id="visual-editor"></div>
  <div id="raw-editor">
    <textarea id="config-editor" spellcheck="false" placeholder="Loading..."></textarea>
  </div>
  <div class="validation-box" id="vbox"></div>
</section>

<!-- â•â•â• LOGS TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section id="tab-logs">
  <div class="log-toolbar">
    <button onclick="$('#log-viewer').innerHTML='';prevLogLen=0">Clear</button>
    <button id="btn-as" class="btn-accent" onclick="autoScroll=!autoScroll;this.textContent='Auto-scroll: '+(autoScroll?'ON':'OFF');this.className=autoScroll?'btn-accent':''">Auto-scroll: ON</button>
    <div class="spacer"></div>
    <span style="font-size:11px;color:var(--text3)" id="log-n">0 lines</span>
  </div>
  <div id="log-viewer"></div>
</section>
</main>
<div id="toast-box"></div>

<script>
/* â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function toast(m,t='info'){const e=document.createElement('div');e.className='toast '+t;e.textContent=m;$('#toast-box').appendChild(e);setTimeout(()=>{e.style.transition='opacity .3s';e.style.opacity='0';setTimeout(()=>e.remove(),300)},3500)}
function keyToLabel(k){return k.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase()).replace(/Api /g,'API ').replace(/Url\b/g,'URL').replace(/Usb\b/g,'USB').replace(/Ws /g,'WS ').replace(/Ms\b/g,'(ms)')}

const SECRET_KEYS=new Set(['api_key','token','bot_token','app_token','access_token','app_secret','client_secret','encrypt_key','verification_token','channel_secret','channel_access_token']);
const SEC_META={agents:{icon:'ğŸ¤–',label:'Agent Settings'},providers:{icon:'ğŸ§ ',label:'LLM Providers'},channels:{icon:'ğŸ’¬',label:'Chat Channels'},tools:{icon:'ğŸ”§',label:'Tools'},heartbeat:{icon:'ğŸ’“',label:'Heartbeat'},devices:{icon:'ğŸ”Œ',label:'Devices'},gateway:{icon:'ğŸŒ',label:'Gateway'}};
const CH_ICON={telegram:'âœˆï¸',discord:'ğŸ®',slack:'ğŸ’¼',whatsapp:'ğŸ“±',feishu:'ğŸ¦',dingtalk:'ğŸ””',line:'ğŸ’š',onebot:'ğŸ§',maixcam:'ğŸ“·',qq:'ğŸ§'};
const PR_ICON={openrouter:'ğŸ”€',anthropic:'ğŸ…°ï¸',openai:'âš¡',groq:'ğŸ”¥',zhipu:'ğŸ‡¨ğŸ‡³',gemini:'â™Š',vllm:'ğŸ–¥ï¸',nvidia:'ğŸ’š',moonshot:'ğŸŒ™',ollama:'ğŸ¦™'};
const SEC_ORDER=['agents','providers','channels','tools','heartbeat','devices','gateway'];

let configData=null, configMode='visual', autoScroll=true, prevLogLen=0;

/* â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
$$('.tab').forEach(t=>t.addEventListener('click',()=>{
  $$('.tab').forEach(x=>x.classList.remove('active'));t.classList.add('active');
  $$('main>section').forEach(x=>x.classList.remove('active'));
  const tab=t.dataset.tab;$('#tab-'+tab).classList.add('active');
  if(tab==='config'&&!configData)loadConfig();
  if(tab==='logs')fetchLogs();
}));

/* â”€â”€ Status polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function fetchStatus(){
  try{
    const r=await fetch('/api/status'),j=await r.json();if(!j.ok)return;const d=j.data;
    const on=d.gateway_running;
    $('#status-pill').className='status-pill'+(on?'':' stopped');
    $('#status-text').textContent=on?'Running':'Stopped';
    $('#hdr-pid').textContent=on?'PID: '+d.gateway_pid:'';
    $('#hdr-uptime').textContent=on?d.uptime:'';
    $('#gw-status').textContent=on?'Running':'Stopped';$('#gw-status').className='value '+(on?'ok':'err');
    $('#gw-pid').textContent=on?d.gateway_pid:'â€”';
    $('#gw-uptime').textContent=on?d.uptime:'â€”';
    if(d.health){$('#gw-health').textContent=d.health.status+' ('+d.health.uptime+')';$('#gw-health').className='value ok'}
    else if(on){$('#gw-health').textContent='connecting...';$('#gw-health').className='value warn'}
    else{$('#gw-health').textContent='â€”';$('#gw-health').className='value'}
    $('#btn-start').disabled=on;$('#btn-stop').disabled=!on;$('#btn-restart').disabled=!on;
    $('#s-bin').textContent=d.binary_path;$('#s-bin').title=d.binary_path;
    $('#s-bin-ok').textContent=d.binary_exists?'Yes':'No';$('#s-bin-ok').className='value '+(d.binary_exists?'ok':'err');
    $('#s-cfg').textContent=d.config_path;$('#s-cfg').title=d.config_path;
    $('#s-cfg-ok').textContent=d.config_exists?'Yes':'No';$('#s-cfg-ok').className='value '+(d.config_exists?'ok':'err');
    $('#s-port').textContent=d.health_port;
  }catch(e){}
}
async function gwAction(url,id){const b=$('#'+id);b.classList.add('loading');try{const r=await fetch(url,{method:'POST'}),j=await r.json();toast(j.message,j.ok?'ok':'err');fetchStatus()}catch(e){toast('Failed','err')}b.classList.remove('loading')}

/* â”€â”€ Config: Load / Save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadConfig(){
  try{
    const r=await fetch('/api/config');
    if(!r.ok){const j=await r.json().catch(()=>null);showEmpty(j?.message||'Cannot load config');return}
    const ct=r.headers.get('content-type')||'';
    const raw=await r.text();
    let parsed;
    try{parsed=JSON.parse(raw)}catch{showEmpty('Config file contains invalid JSON');return}
    if(parsed.ok===false){showEmpty(parsed.message);return}
    configData=parsed;
    buildVisualEditor(configData);
    $('#config-editor').value=JSON.stringify(configData,null,2);
    hideVBox();
  }catch(e){showEmpty('Error loading config: '+e.message)}
}
function showEmpty(msg){
  $('#visual-editor').innerHTML='<div class="empty-state"><h3>No Configuration</h3><p>'+esc(msg)+'</p><button class="btn-accent" onclick="createDefault()">Create Default Config</button></div>';
  configData=null;
}
async function saveConfig(){
  let data;
  if(configMode==='visual'){if(!configData){toast('No config loaded','err');return}data=collectForm()}
  else{try{data=JSON.parse($('#config-editor').value)}catch(e){toast('Invalid JSON: '+e.message,'err');return}}
  try{
    const r=await fetch('/api/config',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
    const j=await r.json();toast(j.message,j.ok?'ok':'err');
    if(j.ok){configData=data;if(configMode==='raw')$('#config-editor').value=JSON.stringify(data,null,2)}
  }catch(e){toast('Save failed','err')}
}
async function validateCfg(){
  let data;
  if(configMode==='visual'){if(!configData){toast('No config','err');return}data=collectForm()}
  else{try{data=JSON.parse($('#config-editor').value)}catch(e){showVBox('err','Invalid JSON: '+e.message);return}}
  try{
    const r=await fetch('/api/validate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
    const j=await r.json();
    if(!j.ok){showVBox('err',j.message);return}
    if(j.data&&j.data.length){showVBox('warn',j.message+'<ul>'+j.data.map(w=>'<li>'+esc(w)+'</li>').join('')+'</ul>')}
    else showVBox('ok',j.message);
  }catch(e){showVBox('err','Error')}
}
async function createDefault(){
  try{const r=await fetch('/api/config',{method:'POST'}),j=await r.json();toast(j.message,j.ok?'ok':'err');if(j.ok)loadConfig()}catch(e){toast('Failed','err')}
}
function showVBox(t,h){const b=$('#vbox');b.className='validation-box '+t;b.innerHTML=h}
function hideVBox(){$('#vbox').className='validation-box'}

function switchMode(m){
  configMode=m;
  $('#mode-visual').className=m==='visual'?'active':'';
  $('#mode-raw').className=m==='raw'?'active':'';
  if(m==='raw'){
    if(configData){const d=collectForm();$('#config-editor').value=JSON.stringify(d,null,2)}
    $('#visual-editor').style.display='none';$('#raw-editor').style.display='';
  }else{
    if($('#config-editor').value){try{configData=JSON.parse($('#config-editor').value);buildVisualEditor(configData)}catch(e){toast('Invalid JSON in editor','err');configMode='raw';$('#mode-visual').className='';$('#mode-raw').className='active';return}}
    $('#visual-editor').style.display='';$('#raw-editor').style.display='none';
  }
}
$('#config-editor').addEventListener('keydown',e=>{
  if(e.key==='Tab'){e.preventDefault();const t=e.target,s=t.selectionStart;t.value=t.value.substring(0,s)+'  '+t.value.substring(t.selectionEnd);t.selectionStart=t.selectionEnd=s+2}
  if(e.ctrlKey&&e.key==='s'){e.preventDefault();saveConfig()}
});

/* â”€â”€ Config: Visual Editor Builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function buildVisualEditor(cfg){
  const c=$('#visual-editor');c.innerHTML='';
  for(const key of SEC_ORDER){
    const data=cfg[key];if(!data)continue;
    const meta=SEC_META[key]||{icon:'ğŸ“¦',label:keyToLabel(key)};
    const sec=document.createElement('div');sec.className='cfg-section open';

    if(key==='agents'&&data.defaults){
      sec.innerHTML=secHdr(meta.icon,meta.label)+`<div class="sec-body">${buildFields(data.defaults,'agents.defaults')}</div>`;
    }
    else if(key==='providers'){
      let inner='';
      for(const[name,prov]of Object.entries(data)){
        if(typeof prov!=='object'||!prov)continue;
        const ico=PR_ICON[name]||'ğŸ“¦';
        inner+=subSec(ico,keyToLabel(name),'providers.'+name,prov);
      }
      sec.innerHTML=secHdr(meta.icon,meta.label)+`<div class="sec-body">${inner}</div>`;
    }
    else if(key==='channels'){
      let inner='';
      for(const[name,ch]of Object.entries(data)){
        if(typeof ch!=='object'||!ch)continue;
        const ico=CH_ICON[name]||'ğŸ“¦';
        const dot=ch.enabled!==undefined?`<div class="sec-status ${ch.enabled?'on':'off'}"></div>`:'';
        inner+=subSec(ico,keyToLabel(name),'channels.'+name,ch,dot);
      }
      sec.innerHTML=secHdr(meta.icon,meta.label)+`<div class="sec-body">${inner}</div>`;
    }
    else if(key==='tools'){
      let inner='';
      for(const[cat,catData]of Object.entries(data)){
        if(typeof catData!=='object'||!catData||Array.isArray(catData))continue;
        const hasNested=Object.values(catData).some(v=>typeof v==='object'&&v!==null&&!Array.isArray(v));
        if(hasNested){
          for(const[name,sub]of Object.entries(catData)){
            if(typeof sub!=='object'||!sub)continue;
            const dot=sub.enabled!==undefined?`<div class="sec-status ${sub.enabled?'on':'off'}"></div>`:'';
            inner+=subSec('',keyToLabel(cat)+' / '+keyToLabel(name),`tools.${cat}.${name}`,sub,dot);
          }
        }else{
          inner+=subSec('',keyToLabel(cat),`tools.${cat}`,catData);
        }
      }
      sec.innerHTML=secHdr(meta.icon,meta.label)+`<div class="sec-body">${inner}</div>`;
    }
    else{
      sec.innerHTML=secHdr(meta.icon,meta.label)+`<div class="sec-body">${buildFields(data,key)}</div>`;
    }
    c.appendChild(sec);
  }
}

function secHdr(icon,label){
  return `<div class="sec-hdr" onclick="toggleSec(this)"><span class="sec-arrow">â–¶</span><span class="sec-icon">${icon}</span><span class="sec-title">${label}</span></div>`;
}
function subSec(icon,label,path,data,extraHdr=''){
  return `<div class="cfg-section sub"><div class="sec-hdr" onclick="toggleSec(this)"><span class="sec-arrow">â–¶</span>${icon?'<span class="sec-icon">'+icon+'</span>':''}<span class="sec-title">${label}</span>${extraHdr}</div><div class="sec-body">${buildFields(data,path)}</div></div>`;
}
function toggleSec(hdr){hdr.parentElement.classList.toggle('open')}

function buildFields(obj,basePath){
  let h='';
  for(const[key,val]of Object.entries(obj)){
    if(typeof val==='object'&&val!==null&&!Array.isArray(val))continue;
    const path=basePath+'.'+key;
    const lbl=keyToLabel(key);

    if(typeof val==='boolean'){
      h+=`<div class="f-row"><label>${lbl}</label><label class="toggle"><input type="checkbox" data-path="${path}" data-type="toggle" ${val?'checked':''} onchange="onToggle(this)"><span class="sl"></span></label></div>`;
    }
    else if(typeof val==='number'){
      if(key==='temperature'){
        h+=`<div class="f-row"><label>${lbl}</label><div class="range-wrap"><input type="range" min="0" max="2" step="0.1" value="${val}" data-path="${path}" data-type="number" oninput="this.nextElementSibling.textContent=this.value"><span class="range-val">${val}</span></div></div>`;
      }else{
        h+=`<div class="f-row"><label>${lbl}</label><input type="number" value="${val}" data-path="${path}" data-type="number"></div>`;
      }
    }
    else if(Array.isArray(val)){
      const tags=val.map(v=>`<span class="tag" data-val="${esc(String(v))}">${esc(String(v))}<span class="tag-x" onclick="rmTag(this)">Ã—</span></span>`).join('');
      h+=`<div class="f-row"><label>${lbl}</label><div class="tags-wrap" data-path="${path}" data-type="tags">${tags}<input class="tag-in" placeholder="Add..." onkeydown="if(event.key==='Enter'){event.preventDefault();addTag(this)}"></div></div>`;
    }
    else if(typeof val==='string'){
      if(SECRET_KEYS.has(key)){
        h+=`<div class="f-row"><label>${lbl}</label><div class="secret-wrap"><input type="password" value="${esc(val)}" data-path="${path}" data-type="text" autocomplete="off"><button type="button" class="eye-btn" onclick="toggleEye(this)" title="Show/Hide">ğŸ‘</button></div></div>`;
      }else{
        h+=`<div class="f-row"><label>${lbl}</label><input type="text" value="${esc(val)}" data-path="${path}" data-type="text"></div>`;
      }
    }
  }
  return h;
}

/* â”€â”€ Config: Collect form â†’ JSON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function collectForm(){
  const cfg=JSON.parse(JSON.stringify(configData));
  document.querySelectorAll('[data-path]').forEach(el=>{
    const parts=el.dataset.path.split('.'), type=el.dataset.type;
    let obj=cfg;
    for(let i=0;i<parts.length-1;i++){if(!obj[parts[i]])obj[parts[i]]={};obj=obj[parts[i]]}
    const k=parts[parts.length-1];
    if(type==='toggle')obj[k]=el.checked;
    else if(type==='number')obj[k]=Number(el.value)||0;
    else if(type==='tags'){obj[k]=Array.from(el.querySelectorAll('.tag')).map(t=>t.dataset.val)}
    else obj[k]=el.value;
  });
  return cfg;
}

/* â”€â”€ Config: Field interactions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function onToggle(inp){
  if(!inp.dataset.path.endsWith('.enabled'))return;
  const sec=inp.closest('.cfg-section');if(!sec)return;
  const dot=sec.querySelector('.sec-hdr .sec-status');
  if(dot)dot.className='sec-status '+(inp.checked?'on':'off');
}
function toggleEye(btn){const inp=btn.previousElementSibling;inp.type=inp.type==='password'?'text':'password'}
function rmTag(x){x.parentElement.remove()}
function addTag(inp){
  const v=inp.value.trim();if(!v)return;
  const tag=document.createElement('span');tag.className='tag';tag.dataset.val=v;
  tag.innerHTML=esc(v)+'<span class="tag-x" onclick="rmTag(this)">Ã—</span>';
  inp.parentElement.insertBefore(tag,inp);inp.value='';
}

/* â”€â”€ Logs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function fetchLogs(){
  try{
    const r=await fetch('/api/logs'),j=await r.json();if(!j.ok)return;
    const logs=j.data||[];if(logs.length===prevLogLen)return;prevLogLen=logs.length;
    const v=$('#log-viewer');
    v.innerHTML=logs.map(l=>{
      const h=esc(l).replace(/^\[(\d{2}:\d{2}:\d{2})\]/,'<span class="ts">[$1]</span>').replace(/\[gateway\]/,'<span class="gw">[gateway]</span>');
      return '<div class="log-line">'+h+'</div>';
    }).join('');
    $('#log-n').textContent=logs.length+' lines';
    if(autoScroll)v.scrollTop=v.scrollHeight;
  }catch(e){}
}

/* â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
fetchStatus();loadConfig();fetchLogs();
setInterval(fetchStatus,2000);
setInterval(()=>fetchLogs(),3000);
</script>
</body>
</html>
